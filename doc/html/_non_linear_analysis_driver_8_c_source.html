<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>fesystem: /Users/manav/Documents/codes/FESystemOld/FESystem/src/AnalysisDriver/NonLinearAnalysisDriver.C Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">fesystem
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>      </li>
      <li class="navelem"><a class="el" href="dir_0c900164955ce081ffb4c6b051e456bf.html">manav</a>      </li>
      <li class="navelem"><a class="el" href="dir_1c27e0e86d47954644c3da6ab29e89d2.html">Documents</a>      </li>
      <li class="navelem"><a class="el" href="dir_702da5bd4e2e61517788da49174c071d.html">codes</a>      </li>
      <li class="navelem"><a class="el" href="dir_549ad45c2f63d8c1db46ab790c4cde83.html">FESystemOld</a>      </li>
      <li class="navelem"><a class="el" href="dir_fa1b40415469e23c583052e363adf212.html">FESystem</a>      </li>
      <li class="navelem"><a class="el" href="dir_f94e632e97ff28080483f5ca56254f08.html">src</a>      </li>
      <li class="navelem"><a class="el" href="dir_515f355191b5a59974307c1423269229.html">AnalysisDriver</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">NonLinearAnalysisDriver.C</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_non_linear_analysis_driver_8_c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// $Id: NonLinearAnalysisDriver.C,v 1.23.4.8 2008/08/21 20:43:10 manav Exp $</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">// C++ includes</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">// FESystem includes</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="_non_linear_analysis_driver_8h.html">AnalysisDriver/NonLinearAnalysisDriver.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="_linear_analysis_driver_8h.html">AnalysisDriver/LinearAnalysisDriver.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="_f_e_system_controller_8h.html">FESystem/FESystemController.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="_analysis_case_8h.html">FESystem/AnalysisCase.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="_f_e_mesh_data_8h.html">Mesh/FEMeshData.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="_global_data_storage_8h.html">Database/GlobalDataStorage.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="_linear_solver_8h.html">Solvers/LinearSolver.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="_nonlinear_solver_8h.html">Solvers/NonlinearSolver.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="_linear_solver_info_8h.html">Solvers/LinearSolverInfo.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="_nonlinear_solver_info_8h.html">Solvers/NonlinearSolverInfo.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="_analysis_discipline_base_8h.html">Discipline/AnalysisDisciplineBase.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="_discipline_info_8h.html">Discipline/DisciplineInfo.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_load_database_8h.html">Loads/LoadDatabase.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_load_combination_8h.html">Loads/LoadCombination.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_load_data_info_8h.html">Loads/LoadDataInfo.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_solution_base_8h.html">Solutions/SolutionBase.h</a>&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="comment">// libMesh includes</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;base/dof_map.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;geom/node.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;numerics/petsc_vector.h&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">// PETSc includes</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;petscvec.h&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a091c00d839ba21410075746a48bb39dd" title="constructor">Driver::NonLinearAnalysisDriver::NonLinearAnalysisDriver</a>
<a name="l00035"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a091c00d839ba21410075746a48bb39dd">00035</a> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ID,
<a name="l00036"></a>00036  <a class="code" href="class_f_e_system_1_1_f_e_system_controller.html">FESystem::FESystemController</a>&amp; fesys_controller):
<a name="l00037"></a>00037 <a class="code" href="class_driver_1_1_analysis_driver.html">Driver::AnalysisDriver</a>(ID, fesys_controller, NONLINEAR_ANALYSIS_DRIVER::num()),
<a name="l00038"></a>00038 iteration_number(0),
<a name="l00039"></a>00039 n_iterations(0)
<a name="l00040"></a>00040 {
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a8e35a72fd3191d23996a90a85c5ae978">00047</a> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a8e35a72fd3191d23996a90a85c5ae978" title="destructor">Driver::NonLinearAnalysisDriver::~NonLinearAnalysisDriver</a>()
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049         
<a name="l00050"></a>00050 }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="keywordtype">void</span>
<a name="l00055"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a4abe039b939a59f58cef433f359e17ef">00055</a> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a4abe039b939a59f58cef433f359e17ef" title="clears the data structures of this object">Driver::NonLinearAnalysisDriver::clear</a>()
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057         this-&gt;iteration_number = 0;
<a name="l00058"></a>00058   this-&gt;n_iterations = 0;
<a name="l00059"></a>00059   
<a name="l00060"></a>00060   <a class="code" href="class_driver_1_1_analysis_driver.html#a1ed98cec18a92ff66e8d183fd16274ea" title="clears the data structure">Driver::AnalysisDriver::clear</a>();
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keywordtype">void</span>
<a name="l00066"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#aa0edbba595140374adddec55200c8589">00066</a> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#aa0edbba595140374adddec55200c8589" title="this method initializes itself before the solutions are started for the driver">Driver::NonLinearAnalysisDriver::initialize</a>()
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00069"></a>00069   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00070"></a>00070   
<a name="l00071"></a>00071   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00072"></a>00072   it = this-&gt;analysis_discipline_map.begin();
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <span class="comment">// now resize the current solution vector</span>
<a name="l00075"></a>00075   Assert(this-&gt;current_solution.size() == 0,ExcInternalError());
<a name="l00076"></a>00076   this-&gt;current_solution.resize(1);
<a name="l00077"></a>00077   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; this-&gt;current_solution.size(); i++)
<a name="l00078"></a>00078     {
<a name="l00079"></a>00079       this-&gt;current_solution.reset(i, NumericVector&lt;double&gt;::build().release());
<a name="l00080"></a>00080       this-&gt;current_solution[i]-&gt;init(it-&gt;second-&gt;getAnalysisDofMap().n_dofs());
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082   
<a name="l00083"></a>00083   <span class="comment">// add the matrices and vectors</span>
<a name="l00084"></a>00084   this-&gt;addMatricesAndVectors();
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#ad7c04afb7a31a8bbe7fe91e3f25a17ef">00089</a> <span class="keywordtype">void</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#ad7c04afb7a31a8bbe7fe91e3f25a17ef" title="function will add the matrices and vectors for this analysis">Driver::NonLinearAnalysisDriver::addMatricesAndVectors</a>()
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00092"></a>00092   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00093"></a>00093   
<a name="l00094"></a>00094   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00095"></a>00095   it = this-&gt;analysis_discipline_map.begin();
<a name="l00096"></a>00096   
<a name="l00097"></a>00097   <span class="comment">// add a system matrix, a solution vector and a rhs</span>
<a name="l00098"></a>00098   it-&gt;second-&gt;initMatrix(this-&gt;addMatrix(<span class="stringliteral">&quot;JacobianMatrix&quot;</span>));
<a name="l00099"></a>00099   it-&gt;second-&gt;initMatrix(this-&gt;addMatrix(<span class="stringliteral">&quot;ScratchMatrix&quot;</span>));
<a name="l00100"></a>00100   it-&gt;second-&gt;initVector(this-&gt;addVector(<span class="stringliteral">&quot;Solution&quot;</span>));
<a name="l00101"></a>00101   it-&gt;second-&gt;initVector(this-&gt;addVector(<span class="stringliteral">&quot;Residual&quot;</span>));
<a name="l00102"></a>00102   it-&gt;second-&gt;initVector(this-&gt;addVector(<span class="stringliteral">&quot;ScratchVector&quot;</span>));
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#aba9ae87532c54f582d3a43cba0237f5b">00109</a> <span class="keywordtype">void</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#aba9ae87532c54f582d3a43cba0237f5b" title="this method solves for the current load case">Driver::NonLinearAnalysisDriver::solveCurrentLoadCase</a>()
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00112"></a>00112   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00113"></a>00113   
<a name="l00114"></a>00114   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00115"></a>00115   it = this-&gt;analysis_discipline_map.begin();
<a name="l00116"></a>00116   
<a name="l00117"></a>00117   <span class="keywordflow">switch</span> (this-&gt;current_analysis_kind_enum_ID)
<a name="l00118"></a>00118   {
<a name="l00119"></a>00119     <span class="keywordflow">case</span> <a class="code" href="_analysis_driver_8h.html#a299e936642c93d0d04386ddc76886557">ANALYSIS_ENUM_ID</a>:
<a name="l00120"></a>00120     {
<a name="l00121"></a>00121       this-&gt;setInitialGuessForCurrentLoadCase();
<a name="l00122"></a>00122       
<a name="l00123"></a>00123       <span class="comment">//  set the matrices and vectors for the solver before the solution</span>
<a name="l00124"></a>00124       <a class="code" href="class_solver_1_1_nonlinear_solver.html">Solver::NonlinearSolver</a>* nonlinear_solver = 
<a name="l00125"></a>00125       <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_solver_1_1_nonlinear_solver.html">Solver::NonlinearSolver</a>*<span class="keyword">&gt;</span>(this-&gt;solver);
<a name="l00126"></a>00126       
<a name="l00127"></a>00127       nonlinear_solver-&gt;<a class="code" href="class_solver_1_1_nonlinear_solver.html#a529feaab634b8b8213c37842ebf2e928">attachMatrixAndVector</a>(this-&gt;getMatrix(<span class="stringliteral">&quot;JacobianMatrix&quot;</span>),
<a name="l00128"></a>00128                                               this-&gt;getVector(<span class="stringliteral">&quot;Residual&quot;</span>));
<a name="l00129"></a>00129       
<a name="l00130"></a>00130       nonlinear_solver-&gt;<a class="code" href="class_solver_1_1_nonlinear_solver.html#a906fea55e6ccf680e5820577c66bd1b5">solve</a>(this-&gt;getVector(<span class="stringliteral">&quot;Solution&quot;</span>));
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132       <span class="keywordflow">break</span>;
<a name="l00133"></a>00133                         
<a name="l00134"></a>00134       
<a name="l00135"></a>00135     <span class="keywordflow">case</span> <a class="code" href="_analysis_driver_8h.html#a57d11dfa38722fcddbcbf4ac842ee2e4">SENSITIVITY_ANALYSIS_ENUM_ID</a>:
<a name="l00136"></a>00136     {
<a name="l00137"></a>00137       <span class="comment">// for a sensitivity analysis, get the dK/dx and myltiply it with the solution vector</span>
<a name="l00138"></a>00138       <span class="comment">// then get dF/dx and calculate the RHS</span>
<a name="l00139"></a>00139       <span class="comment">// then get the system matrix, apply BC and return</span>
<a name="l00140"></a>00140       
<a name="l00141"></a>00141       std::map&lt;unsigned int, double&gt; real_map;
<a name="l00142"></a>00142       std::map&lt;unsigned int, SparseMatrix&lt;double&gt;*&gt; matrix_map;
<a name="l00143"></a>00143       std::map&lt;unsigned int, NumericVector&lt;double&gt;*&gt; vector_map;
<a name="l00144"></a>00144       
<a name="l00145"></a>00145       <span class="comment">// multiply this matrix with the solution vector</span>
<a name="l00146"></a>00146       SparseMatrix&lt;double&gt;&amp; system_matrix = this-&gt;getMatrix(<span class="stringliteral">&quot;JacobianMatrix&quot;</span>);
<a name="l00147"></a>00147       SparseMatrix&lt;double&gt;&amp; scratch_matrix = this-&gt;getMatrix(<span class="stringliteral">&quot;ScratchMatrix&quot;</span>);
<a name="l00148"></a>00148       NumericVector&lt;double&gt;&amp; scratch_vec = this-&gt;getVector(<span class="stringliteral">&quot;ScratchVector&quot;</span>);
<a name="l00149"></a>00149       NumericVector&lt;double&gt;&amp; rhs_vec = this-&gt;getVector(<span class="stringliteral">&quot;Residual&quot;</span>);
<a name="l00150"></a>00150       NumericVector&lt;double&gt;&amp; sol_vec = this-&gt;getVector(<span class="stringliteral">&quot;Solution&quot;</span>);
<a name="l00151"></a>00151       
<a name="l00152"></a>00152       system_matrix.zero();
<a name="l00153"></a>00153       scratch_matrix.zero();
<a name="l00154"></a>00154       scratch_vec.zero();
<a name="l00155"></a>00155       rhs_vec.zero();
<a name="l00156"></a>00156       sol_vec.zero();
<a name="l00157"></a>00157       
<a name="l00158"></a>00158       matrix_map[Driver::JACOBIAN_MATRIX::num()] = &amp;system_matrix;
<a name="l00159"></a>00159       matrix_map[Driver::SYSTEM_MATRIX_SENSITIVITY::num()] = &amp;scratch_matrix;
<a name="l00160"></a>00160       vector_map[Driver::FORCE_VECTOR_SENSITIVITY::num()] = &amp;scratch_vec;
<a name="l00161"></a>00161       
<a name="l00162"></a>00162       <span class="comment">// create a numeric vector and get the solution from the database</span>
<a name="l00163"></a>00163       <a class="code" href="class_f_e_system_database_1_1_time_independent_data_info.html" title="this defines a time independent quantity">FESystemDatabase::TimeIndependentDataInfo</a> data_info;
<a name="l00164"></a>00164       data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#ac1115d95573153291185f76a1540f0e1" title="sets the discipline enum ID">setDisciplineEnumID</a>(it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00165"></a>00165       data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#a117399f629d87ea1b646333d91dee39f" title="sets the name of the quantity">setName</a>(<span class="stringliteral">&quot;Solution&quot;</span>);
<a name="l00166"></a>00166       data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#a700ae1ec3358b497305c2099fbf1cfea" title="sets the load case value, and also sets to true the boolean value of if_load_case_dependent">setLoadCase</a>(this-&gt;current_load_case);
<a name="l00167"></a>00167       
<a name="l00168"></a>00168       this-&gt;fesystem_controller.global_data_storage-&gt;fillVector(data_info, sol_vec);
<a name="l00169"></a>00169       
<a name="l00170"></a>00170       <span class="comment">// now localize the current solution vector</span>
<a name="l00171"></a>00171       this-&gt;localizeSolution(it-&gt;second-&gt;getAnalysisDofMap(), sol_vec, 
<a name="l00172"></a>00172                              *(this-&gt;current_solution[0]));
<a name="l00173"></a>00173       
<a name="l00174"></a>00174       it-&gt;second-&gt;fillQuantity(real_map, matrix_map, vector_map);
<a name="l00175"></a>00175       
<a name="l00176"></a>00176       <span class="comment">// perform the multiplication</span>
<a name="l00177"></a>00177       scratch_matrix.multiply_vector(sol_vec, rhs_vec);
<a name="l00178"></a>00178       
<a name="l00179"></a>00179       <span class="comment">// finally, perform the subtraction to get the RHS</span>
<a name="l00180"></a>00180       rhs_vec.add(-1.0, scratch_vec);
<a name="l00181"></a>00181       rhs_vec.scale(-1.0);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183       this-&gt;applyBoundaryConditionsToVectorForCurrentAnalysis
<a name="l00184"></a>00184       (rhs_vec, <span class="keyword">false</span>, it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00185"></a>00185       this-&gt;applyBoundaryConditionsToMatrixForCurrentAnalysis
<a name="l00186"></a>00186       (system_matrix, 1.0, it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00187"></a>00187 
<a name="l00188"></a>00188       system_matrix.close();
<a name="l00189"></a>00189       rhs_vec.close();
<a name="l00190"></a>00190       
<a name="l00191"></a>00191       <span class="comment">// finally, solve the system</span>
<a name="l00192"></a>00192       <a class="code" href="class_solver_1_1_linear_solver.html">Solver::LinearSolver</a>* linear_solver = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_solver_1_1_linear_solver.html">Solver::LinearSolver</a>*<span class="keyword">&gt;</span>(this-&gt;solver);
<a name="l00193"></a>00193       
<a name="l00194"></a>00194       sol_vec.zero();   
<a name="l00195"></a>00195       linear_solver-&gt;<a class="code" href="class_solver_1_1_linear_solver.html#ac94f10e970be59bf27468b6e2cc9ea6b">setSystemMatrix</a>(system_matrix);
<a name="l00196"></a>00196       linear_solver-&gt;<a class="code" href="class_solver_1_1_linear_solver.html#accc4d30bb755afcd90b457d648e5ad43">setPreconditionerMatrix</a>(system_matrix);
<a name="l00197"></a>00197       linear_solver-&gt;<a class="code" href="class_solver_1_1_linear_solver.html#aa2932e9f9425532adfb25e1331d63a01">solve</a>(rhs_vec, sol_vec);
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199       <span class="keywordflow">break</span>;
<a name="l00200"></a>00200       
<a name="l00201"></a>00201     <span class="keywordflow">default</span>:
<a name="l00202"></a>00202       abort();
<a name="l00203"></a>00203       <span class="keywordflow">break</span>;      
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205   
<a name="l00206"></a>00206   
<a name="l00207"></a>00207   
<a name="l00208"></a>00208   <a class="code" href="class_f_e_system_database_1_1_time_independent_data_info.html" title="this defines a time independent quantity">FESystemDatabase::TimeIndependentDataInfo</a> data_info;
<a name="l00209"></a>00209   data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#ac1115d95573153291185f76a1540f0e1" title="sets the discipline enum ID">setDisciplineEnumID</a>(it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00210"></a>00210   data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#a117399f629d87ea1b646333d91dee39f" title="sets the name of the quantity">setName</a>(<span class="stringliteral">&quot;Solution&quot;</span>);
<a name="l00211"></a>00211   data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#a700ae1ec3358b497305c2099fbf1cfea" title="sets the load case value, and also sets to true the boolean value of if_load_case_dependent">setLoadCase</a>(this-&gt;current_load_case);
<a name="l00212"></a>00212   <span class="keywordflow">if</span> (this-&gt;getCurrentAnalysisKind() == Driver::SENSITIVITY_ANALYSIS::num())
<a name="l00213"></a>00213     data_info.<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#aa63ba2f5c068275a8adc489de219ef6b" title="sets the DV_ID, and also sets to true the boolean value of if_sensitivity">setDVID</a>(this-&gt;getCurrentDesignParameter().getID());
<a name="l00214"></a>00214   
<a name="l00215"></a>00215   <span class="comment">// save the solution vector to the database</span>
<a name="l00216"></a>00216   NumericVector&lt;double&gt;&amp; sol = this-&gt;getVector(<span class="stringliteral">&quot;Solution&quot;</span>);
<a name="l00217"></a>00217   this-&gt;fesystem_controller.global_data_storage-&gt;storeVector(data_info, sol);
<a name="l00218"></a>00218   this-&gt;writeSolutionVectorToLog(data_info, sol, it-&gt;second-&gt;<a class="code" href="class_f_e_system_database_1_1_generic_data_info_base.html#ad7d5d16af602157f9acc9c4e1e9b56c2">getDisciplineEnumID</a>());
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a36f599bc6d8d7834b6ac9a64198e53b9">00224</a> <span class="keywordtype">void</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a36f599bc6d8d7834b6ac9a64198e53b9" title="method sets the initial guess for the nonlinear solver">Driver::NonLinearAnalysisDriver::setInitialGuessForCurrentLoadCase</a>()
<a name="l00225"></a>00225 {  
<a name="l00226"></a>00226   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00227"></a>00227   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00228"></a>00228   
<a name="l00229"></a>00229   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00230"></a>00230   it = this-&gt;analysis_discipline_map.begin();
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   <span class="comment">// get reference to the current solution vector from the solver</span>
<a name="l00233"></a>00233   NumericVector&lt;double&gt;&amp; vector = this-&gt;getVector(<span class="stringliteral">&quot;Solution&quot;</span>);
<a name="l00234"></a>00234         
<a name="l00235"></a>00235   <span class="comment">// set the value of the vector to the initialization value/vector</span>
<a name="l00236"></a>00236   <span class="comment">// specified in the input file</span>
<a name="l00237"></a>00237   
<a name="l00238"></a>00238   <span class="comment">// first check the method that has been specified for initialization</span>
<a name="l00239"></a>00239   std::string method = 
<a name="l00240"></a>00240   this-&gt;fesystem_controller.analysis_case-&gt;getStringParameter(<span class="stringliteral">&quot;SOL_VECTOR_INIT_METHOD&quot;</span>);
<a name="l00241"></a>00241   
<a name="l00242"></a>00242   <span class="keywordflow">if</span> (method == <span class="stringliteral">&quot;VALUE&quot;</span>)
<a name="l00243"></a>00243     {
<a name="l00244"></a>00244       <span class="keywordtype">double</span> init_value = 
<a name="l00245"></a>00245       this-&gt;fesystem_controller.analysis_case-&gt;getRealParameter(<span class="stringliteral">&quot;SOL_VECTOR_INIT_VALUE&quot;</span>);
<a name="l00246"></a>00246       
<a name="l00247"></a>00247       Vec sol_vec = <span class="keyword">dynamic_cast&lt;</span>PetscVector&lt;double&gt;&amp;<span class="keyword">&gt;</span>(vector).vec();
<a name="l00248"></a>00248       VecSet(sol_vec, init_value);
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (method == <span class="stringliteral">&quot;VECTOR&quot;</span>)
<a name="l00251"></a>00251     {
<a name="l00252"></a>00252       <span class="comment">// this needs to be implemented. This requires support for reading arbitrary vectors</span>
<a name="l00253"></a>00253       <span class="comment">// and matrices from the disk.</span>
<a name="l00254"></a>00254       Assert(<span class="keyword">false</span>, ExcInternalError());
<a name="l00255"></a>00255       <span class="comment">//       std::string vec_name = </span>
<a name="l00256"></a>00256       <span class="comment">//        this-&gt;fesystem_controller.analysis_case-&gt;getStringParameter(&quot;SOL_VECTOR_INIT_VECTOR_FILE&quot;);</span>
<a name="l00257"></a>00257       <span class="comment">//       unsigned int load_case = this-&gt;getCurrentLoadCase();</span>
<a name="l00258"></a>00258       <span class="comment">//       this-&gt;fesystem_controller.global_data_storage-&gt;fillVector(, vector);</span>
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260   
<a name="l00261"></a>00261   this-&gt;applyBoundaryConditionsToVectorForCurrentAnalysis(vector, <span class="keyword">true</span>, it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a195e3a6ca9a39d6d8e428f2b3221109d">00268</a> <span class="keywordtype">void</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a195e3a6ca9a39d6d8e428f2b3221109d">Driver::NonLinearAnalysisDriver::getResidualAtVector</a>(NumericVector&lt;double&gt;&amp; sol,
<a name="l00269"></a>00269                                                           NumericVector&lt;double&gt;&amp; res)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00272"></a>00272   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00273"></a>00273   
<a name="l00274"></a>00274   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00275"></a>00275   it = this-&gt;analysis_discipline_map.begin();
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="comment">// set the current solution and calculate the residual</span>
<a name="l00278"></a>00278   Assert(this-&gt;current_solution.size() &gt; 0, ExcInternalError());
<a name="l00279"></a>00279   <span class="comment">// now localize the current solution vector</span>
<a name="l00280"></a>00280   this-&gt;localizeSolution(it-&gt;second-&gt;getAnalysisDofMap(), sol, 
<a name="l00281"></a>00281                          *(this-&gt;current_solution[0]));
<a name="l00282"></a>00282   
<a name="l00283"></a>00283   <span class="comment">// if a basic analysis is being performed, then ask for the basic quantities, apply BC and return</span>
<a name="l00284"></a>00284   SparseMatrix&lt;double&gt;&amp; matrix = this-&gt;getMatrix(<span class="stringliteral">&quot;ScratchMatrix&quot;</span>);
<a name="l00285"></a>00285   NumericVector&lt;double&gt;&amp; scratch_vec = this-&gt;getVector(<span class="stringliteral">&quot;ScratchVector&quot;</span>); 
<a name="l00286"></a>00286   matrix.zero();
<a name="l00287"></a>00287   matrix.close();
<a name="l00288"></a>00288   scratch_vec.zero();
<a name="l00289"></a>00289   scratch_vec.close();
<a name="l00290"></a>00290   
<a name="l00291"></a>00291   res.zero();
<a name="l00292"></a>00292   res.close();
<a name="l00293"></a>00293   
<a name="l00294"></a>00294   std::map&lt;unsigned int, double&gt; real_map;
<a name="l00295"></a>00295   std::map&lt;unsigned int, SparseMatrix&lt;double&gt;*&gt; matrix_map;
<a name="l00296"></a>00296   std::map&lt;unsigned int, NumericVector&lt;double&gt;*&gt; vector_map;
<a name="l00297"></a>00297   
<a name="l00298"></a>00298   matrix_map[Driver::SYSTEM_MATRIX::num()] = &amp;matrix;
<a name="l00299"></a>00299   vector_map[Driver::FORCE_VECTOR::num()] = &amp;scratch_vec;
<a name="l00300"></a>00300   
<a name="l00301"></a>00301   <span class="comment">// fill the matrices and vectors with the required quantities</span>
<a name="l00302"></a>00302   it-&gt;second-&gt;fillQuantity(real_map, matrix_map, vector_map);
<a name="l00303"></a>00303   
<a name="l00304"></a>00304   <span class="comment">// perform multiplication K * X - F</span>
<a name="l00305"></a>00305   matrix.close();
<a name="l00306"></a>00306   scratch_vec.close();
<a name="l00307"></a>00307   matrix.multiply_vector(sol, res);
<a name="l00308"></a>00308   res.add(-1.0, scratch_vec);
<a name="l00309"></a>00309   res.close();
<a name="l00310"></a>00310   
<a name="l00311"></a>00311   this-&gt;applyBoundaryConditionsToVectorForCurrentAnalysis(res, <span class="keyword">false</span>, it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00312"></a>00312   res.close();
<a name="l00313"></a>00313   
<a name="l00314"></a>00314   this-&gt;current_solution[0]-&gt;zero();
<a name="l00315"></a>00315   
<a name="l00316"></a>00316   <span class="comment">// return control back to the solver</span>
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#abb83f71cfeafcbfa129e27ef89c296eb">00321</a> <span class="keywordtype">void</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#abb83f71cfeafcbfa129e27ef89c296eb">Driver::NonLinearAnalysisDriver::getJacobianAtVector</a>(NumericVector&lt;double&gt;&amp; sol,
<a name="l00322"></a>00322                                                           SparseMatrix&lt;double&gt;&amp; jac)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324   <span class="comment">// this is a uni-discipline driver. Make sure that the number of disciplines here is one</span>
<a name="l00325"></a>00325   Assert(this-&gt;analysis_discipline_map.size() == 1, ExcInternalError());
<a name="l00326"></a>00326   
<a name="l00327"></a>00327   std::map&lt;unsigned int, Discipline::AnalysisDisciplineBase*&gt;::iterator it;
<a name="l00328"></a>00328   it = this-&gt;analysis_discipline_map.begin();
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   <span class="comment">// set the current solution and calculate the jacobian</span>
<a name="l00331"></a>00331   Assert(this-&gt;current_solution.size() &gt; 0, ExcInternalError());
<a name="l00332"></a>00332   <span class="comment">// now localize the current solution vector</span>
<a name="l00333"></a>00333   this-&gt;localizeSolution(it-&gt;second-&gt;getAnalysisDofMap(), sol, 
<a name="l00334"></a>00334                          *(this-&gt;current_solution[0]));
<a name="l00335"></a>00335   
<a name="l00336"></a>00336   <span class="comment">// fill the system matrix with the jacobian matrix</span>
<a name="l00337"></a>00337   std::map&lt;unsigned int, double&gt; real_map;
<a name="l00338"></a>00338   std::map&lt;unsigned int, SparseMatrix&lt;double&gt;*&gt; matrix_map;
<a name="l00339"></a>00339   std::map&lt;unsigned int, NumericVector&lt;double&gt;*&gt; vector_map;
<a name="l00340"></a>00340   
<a name="l00341"></a>00341   jac.zero();
<a name="l00342"></a>00342   jac.close();
<a name="l00343"></a>00343   matrix_map[Driver::JACOBIAN_MATRIX::num()] = &amp;jac;
<a name="l00344"></a>00344   
<a name="l00345"></a>00345   it-&gt;second-&gt;fillQuantity(real_map, matrix_map, vector_map);
<a name="l00346"></a>00346   jac.close();
<a name="l00347"></a>00347   
<a name="l00348"></a>00348   this-&gt;applyBoundaryConditionsToMatrixForCurrentAnalysis
<a name="l00349"></a>00349   (jac, 1.0, it-&gt;second-&gt;getDisciplineEnumID());
<a name="l00350"></a>00350   jac.close();
<a name="l00351"></a>00351   
<a name="l00352"></a>00352   this-&gt;current_solution[0]-&gt;zero();
<a name="l00353"></a>00353   <span class="comment">// return control back to the solver</span>
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a87468a3d2e1edf396602de56c10b7340">00357</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_driver_1_1_non_linear_analysis_driver.html#a87468a3d2e1edf396602de56c10b7340" title="returns the current iteration number of the nonlinear solution">Driver::NonLinearAnalysisDriver::currentNonlinearIterationNumber</a>()<span class="keyword"> const</span>
<a name="l00358"></a>00358 <span class="keyword"></span>{
<a name="l00359"></a>00359   <span class="keywordflow">return</span> (dynamic_cast&lt;Solver::NonlinearSolver*&gt;(this-&gt;solver)-&gt;getCurrentIterationNumber());
<a name="l00360"></a>00360 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Thu Apr 12 2012 18:06:16 for fesystem by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
